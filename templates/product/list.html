{% extends 'base.html' %}
{% load static %}
{% load tags %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mt-3 mb-4 gap-3 flex-wrap">
    <div class="d-flex align-items-center gap-3">
        <h2 class="mb-0 fw-bold text-dark">Каталог</h2>
        <button type="button" class="btn btn-dark">
            Всего товаров: {{ products_count }}
        </button>
        {% if request.GET and filters.qs.exists %}
        <button type="button" class="btn btn-dark">
            Найдено товаров: {{ filters.qs.count }}
        </button>
        {% endif %}
    </div>  
    <div class="d-flex align-items-center gap-2">
        <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#filterModal">
            Фильтр
        </button>
        
        <a href="{% url 'product-create' %}" class="btn btn-primary">
            <span>Добавить</span>
        </a>
        <div class="dropdown">
            <button class="btn btn-secondary rounded-circle p-2" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                <i class='bx bx-dots-vertical-rounded'></i>
              </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton1">
                <li>
                    <button class="dropdown-item d-flex align-items-center gap-2" id="toggle-checkboxes-header">
                        <i class='bx bx-check'></i>
                        <span id="toggle-button">Выбрать</span>
                    </button>
                </li>
                <li>
                    <button class="dropdown-item d-flex align-items-center gap-2" id="importButton">
                        <i class='bx bx-import'></i>
                        <span>Импорт</span>
                    </button>
                </li>
                <li>
                    <button class="dropdown-item d-flex align-items-center gap-2" id="exportButton">
                        <i class='bx bx-export'></i>
                        <span>Экспорт</span>
                    </button>
                </li>
                <li>
                    <button class="dropdown-item d-flex align-items-center gap-2" id="deleteButton">
                        <i class='bx bx-trash'></i>
                        <span>Удалить</span>
                    </button>
                </li>
                <li>
                    <button class="dropdown-item d-flex align-items-center gap-2" id="pageSettings">
                        <i class='bx bx-cog'></i>
                        <span>Настройки страницы</span>
                    </button>
                </li>
            </ul>
            
            <!-- Модальные окна -->
            <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">Импорт товаров из CSV</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold" for="upload_csv">Загрузить CSV файл</label>
                                <input type="file" class="form-control" id="upload_csv" accept=".csv">
                            </div>
            
                            <div class="alert alert-warning d-flex align-items-center" role="alert">
                                <i class="bx bx-exclamation-triangle me-2"></i>
                                <span>Убедитесь, что названия полей в вашем CSV файле соответствуют указанным ниже! <br>Пример файла: exeple_products.csv</span>
                            </div>
            
                            <h6 class="fw-bold mb-2">Информация о полях</h6>
                            <div class="accordion" id="fieldsAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingRequired">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRequired" aria-expanded="true" aria-controls="collapseRequired">
                                            Обязательные поля
                                        </button>
                                    </h2>
                                    <div id="collapseRequired" class="accordion-collapse collapse show" aria-labelledby="headingRequired" data-bs-parent="#fieldsAccordion">
                                        <div class="accordion-body">
                                            <ul class="list-unstyled">
                                                <li><strong>name</strong> — Название товара (уникальное в пределах магазина)</li>
                                                <li><strong>category</strong> — Название категории (будет создана, если не существует)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingOptional">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOptional" aria-expanded="false" aria-controls="collapseOptional">
                                            Необязательные поля
                                        </button>
                                    </h2>
                                    <div id="collapseOptional" class="accordion-collapse collapse" aria-labelledby="headingOptional" data-bs-parent="#fieldsAccordion">
                                        <div class="accordion-body">
                                            <ul class="list-unstyled">
                                                <li><strong>cost_price</strong> — Себестоимость товара (число, по умолчанию 0)  </li>
                                                <li><strong>sale_price</strong> — Цена продажи (число, по умолчанию 0)</li>
                                                <li><strong>discount</strong> — Скидка в процентах (число, по умолчанию 0)</li>
                                                <li><strong>unit</strong> — Единица измерения (текст, по умолчанию "шт")</li>
                                                <li><strong>bar_code</strong> — Штрихкод (текст, по умолчанию не указано)</li>
                                                <li><strong>quantity</strong> — Количество на складе (число, по умолчанию 0)</li>
                                                <li><strong>min_quantity</strong> — Минимальный остаток (число, по умолчанию 10)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">Экспорт выбранных товаров</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info d-flex align-items-center" role="alert">
                                <i class="bx bx-info-circle me-2"></i>
                                <span>Выберите формат и поля для экспорта выбранных товаров.</span>
                            </div>
                    
                            <h6 class="fw-bold mb-2">Формат экспорта</h6>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="exportFormat" id="exportCsv" value="csv" checked>
                                    <label class="form-check-label" for="exportCsv">CSV</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="exportFormat" id="exportExcel" value="xlsx">
                                    <label class="form-check-label" for="exportExcel">Excel (XLSX)</label>
                                </div>
                            </div>
                    
                            <h6 class="fw-bold mb-2">Поля для экспорта</h6>
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-check">
                                        <input class="form-check-input export-field" type="checkbox" value="name" id="fieldName" disabled checked>
                                        <label class="form-check-label" for="fieldName">Название (name) — Обязательное</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-field" type="checkbox" value="category__name" id="fieldCategory" disabled checked>
                                        <label class="form-check-label" for="fieldCategory">Категория (category) — Обязательное</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-field" type="checkbox" value="cost_price" id="fieldCostPrice">
                                        <label class="form-check-label" for="fieldCostPrice">Себестоимость (cost_price)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-field" type="checkbox" value="sale_price" id="fieldSalePrice">
                                        <label class="form-check-label" for="fieldSalePrice">Цена продажи (sale_price)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-field" type="checkbox" value="discount" id="fieldDiscount">
                                        <label class="form-check-label" for="fieldDiscount">Скидка (discount)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-field" type="checkbox" value="unit" id="fieldUnit">
                                        <label class="form-check-label" for="fieldUnit">Единица измерения (unit)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-field" type="checkbox" value="bar_code" id="fieldBarCode">
                                        <label class="form-check-label" for="fieldBarCode">Штрихкод (bar_code)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-field" type="checkbox" value="quantity" id="fieldQuantity">
                                        <label class="form-check-label" for="fieldQuantity">Количество (quantity)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-field" type="checkbox" value="min_quantity" id="fieldMinQuantity">
                                        <label class="form-check-label" for="fieldMinQuantity">Минимальный остаток (min_quantity)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                            <button type="button" class="btn btn-primary" id="exportSubmit">Экспортировать</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">Удаление выбранных товаров</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning d-flex align-items-center" role="alert">
                                <i class="bx bx-exclamation-triangle me-2"></i>
                                <span>Вы собираетесь удалить выбранные товары. Это действие необратимо!</span>
                            </div>
                            <p>Вы уверены, что хотите удалить <span id="deleteCount">0</span> выбранных товаров?</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                            <button type="button" class="btn btn-danger" id="deleteSubmit">Удалить</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="settingsModalLabel">Настройки</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                        </div>
                        <div class="modal-body">
                            <form method="post" action="{% url 'update-per-pages' %}">    
                                {% csrf_token %}
                                <span>Введите количество товаров на странице</span>
                                <input type="number" class="form-control" name="number_per_page" value="{{ number_per_page }}">
                                <div class="alert alert-warning d-flex align-items-center mt-2" role="alert">
                                    <i class="bx bx-exclamation-triangle me-2"></i>
                                    <span>Эта настройка касается всем пользователям магазина</span>
                                </div>
                                <button type="submit" name="products" class="btn btn-primary">Сохранить</button>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="d-flex align-items-center mb-2">
    <input type="checkbox" id="select-all" class="form-check-input me-2 d-none">
    <button type="button" id="select-all-pages" class="btn btn-link fw-bold me-3 d-none">Выбрать все</button>
    <span class="text-muted d-none" id="selected-count">Выбрано: 0</span>
    <button type="button" class="btn btn-danger ms-3 d-none" id="cancel-selection">Очистить</button>
</div>
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th class="checkbox-col">
                                    <input type="checkbox" id="select-all-header" class="form-check-input checkbox-slide d-none ms-1">
                                </th>
                                <th>Название</th>
                                <th>Категория</th>
                                <th>В наличии</th>
                                <th>Цена</th>
                                <th>Цена для продажи</th>
                                <th>Кол-во</th>
                                <th>Ед.</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in page_obj %}
                            <tr>
                                <td class="checkbox-col">
                                    <input type="checkbox" class="form-check-input product-checkbox checkbox-slide d-none ms-1" 
                                    data-product-id="{{ product.id|stringformat:'s' }}" 
                                    {% if product.id|stringformat:'s' in selected_ids %}checked{% endif %}>
                                </td>
                                <td>
                                    <a href="{% url 'product-details' product.id %}" class="d-flex justify-content-start align-items-center product-name">
                                        <div class="d-flex flex-column">
                                            <h6 class="text-nowrap mb-0">{{ product.name|truncatechars:20 }}</h6>
                                            <span class="text-muted d-flex align-items-center gap-2">
                                                <i class="bx bx-barcode"></i>
                                                {% if product.bar_code %}{{ product.bar_code }}{% else %}Без баркода{% endif %}
                                            </span>
                                        </div>
                                    </a>
                                </td>
                                <td>{{ product.category }}</td>
                                <td>
                                    {% if product.quantity == 0 %}
                                    <span class="badge bg-label-danger">Нет в наличии</span>
                                    {% else %}
                                    {% if product.quantity < product.min_quantity %} 
                                    <span class="badge bg-label-warning">Малый остаток</span>
                                    {% else %}
                                    <span class="badge bg-label-success">В наличии</span>
                                    {% endif %}
                                    {% endif %}
                                </td>
                                <td>{{ product.cost_price }}</td>
                                <td>{{ product.discounted_price }}{% if product.discount > 0 %} <sup><span class="text-danger">-{{ product.discount }}%</span></sup> {% endif %}</td>
                                <td>{{ product.quantity }}</td>
                                <td>{{ product.unit }}</td>
                                <td>
                                    <div class="d-flex align-items-center gap-1">
                                        <a class="btn" href="{% url 'product-update' product.id %}">
                                            <i class="bx bx-edit fs-5"></i>
                                        </a>
                                        <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#modalDelete{{ product.id }}">
                                            <i class="bx bx-trash fs-5"></i>
                                        </button>
                                        <div class="modal fade" id="modalDelete{{ product.id }}" tabindex="-1" aria-labelledby="modalDelete" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="modalDeleteLable">Удаление</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                                                    </div>
                                                    <div>
                                                        <div class="modal-body">
                                                            <p>Вы действительно хотите удалить "{{ product.name }}"?</p>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                                                            <a href="{% url 'product-delete' product.id %}" class="btn btn-danger">Удалить</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="d-flex align-items-center justify-content-center me-3 mt-5 flex-wrap">
                    <div class="pagination-container">
                        <nav aria-label="Пагинация">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.number > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="?{% query_transform request page=1 %}" aria-label="Первая">
                                    <span aria-hidden="true">««</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">««</span>
                            </li>
                            {% endif %}
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% query_transform request page=page_obj.previous_page_number %}" aria-label="Назад">
                                    <span aria-hidden="true">«</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">«</span>
                            </li>
                            {% endif %}
                            {% for page_num in visible_pages %}
                            {% if page_num == page_obj.number %}
                            <li class="page-item active" aria-current="page">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link" href="?{% query_transform request page=page_num %}">{{ page_num }}</a>
                            </li>
                            {% endif %}
                            {% endfor %}
                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% query_transform request page=page_obj.next_page_number %}" aria-label="Вперёд">
                                    <span aria-hidden="true">»</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">»</span>
                            </li>
                            {% endif %}
                            {% if page_obj.number < page_obj.paginator.num_pages %}
                            <li class="page-item">
                                <a class="page-link" href="?{% query_transform request page=page_obj.paginator.num_pages %}" aria-label="Последняя">
                                    <span aria-hidden="true">»»</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">»»</span>
                            </li>
                            {% endif %}
                        </ul>
                        </nav>
                        <div class="text-center mt-2">
                            <small class="text-muted">Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal modal-top fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Фильтр</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <form id="filterForm" method="GET" action="{% url 'product-list' %}">
                <div class="modal-body row gy-3">
                    {{ filters.form.as_p }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-outline-danger" id="resetFilter">Сбросить</button>
                    <button type="submit" class="btn btn-primary">Показать</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .hidden {
        display: none;
    }
    .btn-link {
        text-decoration: none;
        color: inherit;
        padding: 0;
    }
    .badge {
        font-size: 0.9rem;
        padding: 0.5em 1em;
    }
    .table th, .table td {
        vertical-align: middle;
    }
    .checkbox-slide {
        transition: transform 0.3s ease, opacity 0.3s ease;
        transform: translateX(-20px);
        opacity: 0;
    }
    .checkbox-slide.visible {
        transform: translateX(0);
        opacity: 1;
    }
    .checkbox-col {
        width: 1%;
        white-space: nowrap;
        padding-left: 0 !important;
    }
    .table {
        margin-bottom: 0;
    }
    .dropdown-menu {
        min-width: 200px;
    }
    .dropdown-item {
        padding: 0.5rem 1rem;
    }
</style>

<script src="{% static 'assets/vendor/libs/jquery/jquery.js' %}"></script>
<script>
    $(document).ready(function() {
        const $toggleBtnHeader = $("#toggle-checkboxes-header");
        const $toggleButton = $("#toggle-button");
        const $checkboxes = $(".product-checkbox");
        const $selectAllHeader = $("#select-all-header");
        const $selectAllOuter = $("#select-all");
        const $selectAllLabel = $("#select-all-pages");
        const $selectedCount = $("#selected-count");
        const $cancelSelection = $("#cancel-selection");
        const $exportButton = $("#exportButton");
        const $deleteButton = $("#deleteButton");
        const $importButton = $("#importButton");
        const $pageSettings = $("#pageSettings");
    
        const STORAGE_KEY = "selectedProducts";
        const CHECKBOX_VISIBILITY_KEY = "checkboxesVisible";
    
        // Обновление состояния UI
        function updateUI() {
            const selectedProducts = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            $selectedCount.text(`Выбрано: ${selectedProducts.length}`);
    
            const pageChecked = $checkboxes.filter(":checked").length;
            const allPageChecked = pageChecked === $checkboxes.length && $checkboxes.length > 0;
            $selectAllHeader.prop("checked", allPageChecked);
    
            $.ajax({
                url: "{% url 'select-all-products' %}",
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                data: JSON.stringify({ filters: window.location.search, check_only: true }),
                success: function(response) {
                    if (response.success) {
                        const allFilteredIds = response.selected_ids;
                        const allSelected = allFilteredIds.every(id => selectedProducts.includes(id));
                        $selectAllOuter.prop("checked", allSelected);
                    }
                },
                error: function() {
                    console.log("Ошибка при проверке состояния выбора");
                }
            });
        }
    
        // Сохранение выбранных продуктов
        function saveSelectedProducts() {
            let selectedProducts = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            $checkboxes.each(function() {
                const productId = $(this).data("product-id");
                const isChecked = $(this).prop("checked");
                if (isChecked && !selectedProducts.includes(productId)) {
                    selectedProducts.push(productId);
                } else if (!isChecked && selectedProducts.includes(productId)) {
                    selectedProducts = selectedProducts.filter(id => id !== productId);
                }
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(selectedProducts));
            updateUI();
        }
    
        // Восстановление состояния чекбоксов
        function restoreSelectedProducts() {
            const selectedProducts = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            $checkboxes.each(function() {
                const productId = $(this).data("product-id");
                $(this).prop("checked", selectedProducts.includes(productId));
            });
            updateUI();
        }
    
        // Очистка выбора
        function clearSelection() {
            localStorage.removeItem(STORAGE_KEY);
            $checkboxes.prop("checked", false);
            $selectAllHeader.prop("checked", false);
            $selectAllOuter.prop("checked", false);
            updateUI();
        }
    
        // Переключение видимости
        function toggleCheckboxes(show) {
            const shouldShow = typeof show === "boolean" ? show : !$checkboxes.hasClass("visible");
            
            if (shouldShow) {
                $checkboxes.removeClass("d-none").addClass("visible");
                $selectAllHeader.removeClass("d-none").addClass("visible");
                $selectAllOuter.removeClass("d-none");
                $selectAllLabel.removeClass("d-none");
                $selectedCount.removeClass("d-none");
                $cancelSelection.removeClass("d-none");
                $toggleButton.text("Скрыть выбор");
                localStorage.setItem(CHECKBOX_VISIBILITY_KEY, "true");
            } else {
                $checkboxes.removeClass("visible");
                setTimeout(() => $checkboxes.addClass("d-none"), 300);
                $selectAllHeader.removeClass("visible");
                setTimeout(() => $selectAllHeader.addClass("d-none"), 300);
                $selectAllOuter.addClass("d-none");
                $selectAllLabel.addClass("d-none");
                $selectedCount.addClass("d-none");
                $cancelSelection.addClass("d-none");
                $toggleButton.text("Выбрать");
                localStorage.removeItem(CHECKBOX_VISIBILITY_KEY);
            }
        }
    
        // Инициализация
        if (localStorage.getItem(CHECKBOX_VISIBILITY_KEY) === "true") {
            toggleCheckboxes(true);
        }
        restoreSelectedProducts();
    
        $toggleBtnHeader.on("click", function() {
            clearSelection();
            toggleCheckboxes();
        });
    
        $selectAllHeader.on("change", function() {
            const isChecked = $(this).prop("checked");
            $checkboxes.prop("checked", isChecked);
            saveSelectedProducts();
        });
    
        $selectAllOuter.on("change", function() {
            const shouldSelect = $(this).prop("checked");
            if (shouldSelect) {
                $.ajax({
                    url: "{% url 'select-all-products' %}",
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json"
                    },
                    data: JSON.stringify({ filters: window.location.search }),
                    success: function(response) {
                        if (response.success) {
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(response.selected_ids));
                            restoreSelectedProducts();
                        } else {
                            $selectAllOuter.prop("checked", false);
                            alert("Ошибка при выборе всех товаров");
                        }
                    },
                    error: function() {
                        $selectAllOuter.prop("checked", false);
                        alert("Ошибка запроса");
                    }
                });
            } else {
                clearSelection();
            }
        });
    
        $checkboxes.on("change", function() {
            saveSelectedProducts();
        });
    
        $cancelSelection.on("click", function() {
            clearSelection();
        });
    
        $selectAllLabel.on("click", function(e) {
            e.preventDefault();
            $selectAllOuter.prop("checked", true).trigger("change");
        });
    
        // Обработчики для кнопок
        $importButton.on("click", function() {
            $("#importModal").modal("show");
        });
    
        $exportButton.on("click", function() {
            const selectedProducts = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            if (selectedProducts.length > 0) {
                $("#exportModal").modal("show");
            } else {
                toggleCheckboxes(true);
            }
        });
    
        $deleteButton.on("click", function() {
            const selectedProducts = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            if (selectedProducts.length > 0) {
                $("#deleteModal").modal("show");
            } else {
                toggleCheckboxes(true);
            }
        });
    
        $pageSettings.on("click", function() {
            $("#settingsModal").modal("show");
        });

        // Обработка экспорта
        $exportButton.on("click", function() {
            const selectedProducts = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            if (selectedProducts.length > 0) {
                $("#exportModal").modal("show");
            } else {
                toggleCheckboxes(true);
            }
        });

        $("#exportSubmit").on("click", function() {
            const selectedProducts = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            if (selectedProducts.length === 0) {
                alert("Нет выбранных товаров для экспорта!");
                $("#exportModal").modal("hide");
                return;
            }

            const format = $("input[name='exportFormat']:checked").val();
            const fields = $(".export-field:checked").map(function() { return $(this).val(); }).get();

            if (fields.length === 0) {
                alert("Выберите хотя бы одно поле для экспорта!");
                return;
            }

            $.ajax({
                url: "{% url 'export-products' %}",
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                data: JSON.stringify({
                    product_ids: selectedProducts,
                    format: format,
                    fields: fields
                }),
                xhrFields: {
                    responseType: 'blob'
                },
                success: function(response, status, xhr) {
                    const filename = xhr.getResponseHeader('Content-Disposition')?.match(/filename="(.+)"/)?.[1] || `exported_products.${format}`;
                    const url = window.URL.createObjectURL(new Blob([response]));
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    $("#exportModal").modal("hide");
                },
                error: function(xhr) {
                    let errorMsg = "Ошибка при экспорте товаров";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg += ": " + xhr.responseJSON.error;
                    }
                    alert(errorMsg);
                }
            });
        });

        // Обработка удаления
        $deleteButton.on("click", function() {
            const selectedProducts = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            if (selectedProducts.length > 0) {
                $("#deleteCount").text(selectedProducts.length);
                $("#deleteModal").modal("show");
            } else {
                toggleCheckboxes(true);
            }
        });

        $("#deleteSubmit").on("click", function() {
            const selectedProducts = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            if (selectedProducts.length === 0) {
                alert("Нет выбранных товаров для удаления!");
                $("#deleteModal").modal("hide");
                return;
            }

            $.ajax({
                url: "{% url 'delete-products' %}",
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                data: JSON.stringify({ product_ids: selectedProducts }),
                success: function(response) {
                    if (response.success) {
                        localStorage.removeItem(STORAGE_KEY);
                        $("#deleteModal").modal("hide");
                        location.reload(); // Обновляем страницу
                    } else {
                        alert("Ошибка при удалении: " + response.error);
                    }
                },
                error: function() {
                    alert("Ошибка запроса к серверу");
                }
            });
        });
    
        $("#resetFilter").on("click", function() {
            $("#filterForm")[0].reset();
            window.location.href = "{% url 'product-list' %}";
        });
    });
    </script>

{% endblock %}