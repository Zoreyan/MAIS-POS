{% extends 'base.html' %}
{% load tags %}
{% load humanize %}
{% load static %}
{% block content %}

<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <form class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filterModalLabel">Фильтр</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {{ filters.form.as_p }}
      </div>      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
        <button type="submit" class="btn btn-primary">Показать</button>
      </div>
    </form>
  </div>
</div>

<div class="d-flex align-items-center justify-content-between mt-3 mb-4 flex-wrap">
  <div class="d-flex align-items-center gap-3">
    <h2 class="mb-0 fw-bold text-dark">Общая история</h2>
    <button type="button" class="btn btn-dark">
      Всего заказов: {{ orders_count }}
    </button>
  </div>
  <div class="d-flex align-items-center gap-2">
    <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#filterModal">
      Фильтр
    </button>
    <div class="dropdown">
      <button class="btn btn-secondary rounded-circle p-2" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
        <i class='bx bx-dots-vertical-rounded'></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton1">
        <li>
          <button class="dropdown-item d-flex align-items-center gap-2" id="toggle-checkboxes-header">
            <i class='bx bx-check'></i>
            <span id="toggle-button">Выбрать</span>
          </button>
        </li>
        <li>
          <button class="dropdown-item d-flex align-items-center gap-2" id="exportButton">
            <i class='bx bx-export'></i>
            <span>Экспорт</span>
          </button>
        </li>
        <li>
          <button class="dropdown-item d-flex align-items-center gap-2" id="deleteButton">
            <i class='bx bx-trash'></i>
            <span>Удалить</span>
          </button>
        </li>
        <li>
          <button class="dropdown-item d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#settingsModal">
              <i class='bx bx-cog'></i>
              <span>Настройки страницы</span>
          </button>
      </li>
      </ul>

      <!-- Модальные окна -->
      <div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">Экспорт выбранных заказов</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-info d-flex align-items-center" role="alert">
                <i class="bx bx-info-circle me-2"></i>
                <span>Выберите формат для экспорта выбранных заказов.</span>
              </div>
              <h6 class="fw-bold mb-2">Формат экспорта</h6>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="exportFormat" id="exportCsv" value="csv" checked>
                  <label class="form-check-label" for="exportCsv">CSV</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="exportFormat" id="exportExcel" value="xlsx">
                  <label class="form-check-label" for="exportExcel">Excel (XLSX)</label>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
              <button type="button" class="btn btn-primary" id="exportSubmit">Экспортировать</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title">Удаление выбранных заказов</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-warning d-flex align-items-center" role="alert">
                <i class="bx bx-exclamation-triangle me-2"></i>
                <span>Вы собираетесь удалить выбранные заказы. Это действие необратимо!</span>
              </div>
              <p>Вы уверены, что хотите удалить <span id="deleteCount">0</span> выбранных заказов?</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
              <button type="button" class="btn btn-danger" id="deleteSubmit">Удалить</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Настройки</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <form method="post" action="{% url 'update-per-pages' %}">    
                        {% csrf_token %}
                        <span>Введите количество товаров на странице</span>
                        <input type="number" class="form-control" name="number_per_page" value="{{ number_per_page }}">
                        <div class="alert alert-warning d-flex align-items-center mt-2" role="alert">
                            <i class="bx bx-exclamation-triangle me-2"></i>
                            <span>Эта настройка касается всем пользователям магазина</span>
                        </div>
                        <button type="submit" name="orderhistory" class="btn btn-primary">Сохранить</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    </div>
  </div>
</div>

<div class="d-flex align-items-center mb-2">
  <input type="checkbox" id="select-all" class="form-check-input me-2 d-none">
  <button type="button" id="select-all-pages" class="btn btn-link fw-bold me-3 d-none">Выбрать все</button>
  <span class="text-muted d-none" id="selected-count">Выбрано: 0</span>
  <button type="button" class="btn btn-danger ms-3 d-none" id="cancel-selection">Очистить</button>
</div>

{% if request.user.role != 'cashier' %}
<section class="row justify-content-between gy-3 mb-2">
  <article class="col-sm-6 col-xl-3">
    <div class="card bg-primary">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between">
          <div class="content-left">
            <span class="text-white">Средний чек</span>
            <div class="d-flex align-items-center my-1">
              <h5 class="mb-0 me-2 text-white">{{ average_receipt|default:0|intcomma }} СОМ</h5>
             
            </div>
          </div>
          <div class="avatar">
            <span class="avatar-initial rounded bg-label-primary">
              <i class="bx bx-bar-chart bx-26px"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
  </article>

  <!-- Продажи -->
  <article class="col-sm-6 col-xl-3">
    <div class="card bg-primary">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between">
          <div class="content-left">
            <span class="text-white">Самый проданный товар</span>
            <div class="d-flex align-items-center my-1">
              <h6 class="mb-0 me-2 text-white ">{{ top_selling_product.name }}</h6>
              <span class="text-white">{{ top_selling_product.quantity }} шт</span>
            </div>
          </div>
          <div class="avatar">
            <span class="avatar-initial rounded bg-label-primary">
              <i class="bx bx-cart bx-26px"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
  </article>

  <!-- Общие расходы -->
  <article class="col-sm-6 col-xl-3">
    <div class="card bg-primary">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between">
          <div class="content-left">
            <span class="text-white">Оплаты наличными</span>
            <div class="d-flex align-items-center my-1">
              <h5 class="mb-0 me-2 text-white">{{ cash_payments|default:0|intcomma }} СОМ</h5>
              
            </div>
          </div>
          <div class="avatar">
            <span class="avatar-initial rounded bg-label-primary">
              <i class="bx bx-money bx-26px"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
  </article>

  <!-- Чистая прибыль -->
  <article class="col-sm-6 col-xl-3">
    <div class="card bg-primary">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between">
          <div class="content-left">
            <span class="text-white">Переводы на карту</span>
            <div class="d-flex align-items-center my-1">
              <h5 class="mb-0 me-2 text-white">{{ card_transfers|default:0|intcomma }} СОМ</h5>
            </div>
          </div>
          <div class="avatar">
            <span class="avatar-initial rounded bg-label-primary">
              <i class="bx bx-wallet bx-26px"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
  </article>
</section>
{% endif %}

<div class="row justify-content-center">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="products-datatable">
            <thead class="table-light">
              <tr>
                <th class="checkbox-col">
                  <input type="checkbox" id="select-all-header" class="form-check-input checkbox-slide d-none ms-1">
                </th>
                <th>Ответственен</th>
                <th><span class="text-info">Наличными</span></th>
                <th><span class="text-success">Онлайн</span></th>
                <th>Сдача</th>
                <th>Итого</th>
                <th>Скидка</th>
                <th>Метод оплаты</th>
                <th>Дата</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="product-table-body">
              {% for order in page_obj %}
              <tr>
                <td class="checkbox-col">
                  <input type="checkbox" class="form-check-input order-checkbox checkbox-slide d-none ms-1" 
                         data-order-id="{{ order.id|stringformat:'s' }}"
                         {% if order.id|stringformat:'s' in selected_ids %}checked{% endif %}>
                </td>
                <td>
                  <span class="text-primary">
                    <a id="openreceipt{{ order.id }}">
                      <i class="mdi mdi-cart me-1">
                        {% if order.user.first_name %}{{ order.user.first_name }}{% else %}{{ order.user.id }}{% endif %}
                      </i>
                    </a>
                  </span>
                </td>
                <td>{{ order.cash_payment }}</td>
                <td>{{ order.online_payment }}</td>
                <td>{% if order.change %}{{ order.change }}{% else %}0{% endif %}</td>
                <td>{{ order.subtotal_sum }}</td>
                <td>{% if order.discount %}{{ order.discount }}{% else %}0{% endif %}</td>
                <td>
                  {% if order.payment_method == 'cash' %}
                  <span class="badge bg-info">{{ order.get_payment_method_display }}</span>
                  {% elif order.payment_method == 'online' %}
                  <span class="badge bg-success">{{ order.get_payment_method_display }}</span>
                  {% elif order.payment_method == 'split' %}
                  <span class="badge bg-warning">{{ order.get_payment_method_display }}</span>
                  {% endif %}
                </td>
                <td>{{ order.created|date:"d.m.Y H:i" }}</td>
                <td>
                  <button id="openreceipt{{ order.id }}" class="btn printReceipt">
                    <i class='bx bxs-printer'></i>
                  </button>
                  <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#deleteModal{{ order.id }}">
                    <i class="bx bx-trash fs-5"></i>
                  </button>
                  <div id="deleteModal{{ order.id }}" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-body">
                          <p>Вы действительно хотите удалить ордер? {{ order.id }}</p>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                          <a class="btn btn-danger" href="{% url 'order-history-delete' order.id %}">Удалить</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="d-flex align-items-center justify-content-center me-3 mt-5 flex-wrap">
          <div class="pagination-container">
              <nav aria-label="Пагинация">
                  <ul class="pagination justify-content-center">
                      {% if page_obj.number > 1 %}
                      <li class="page-item">
                          <a class="page-link" href="?page=1" aria-label="Первая">
                              <span aria-hidden="true">&laquo;&laquo;</span>
                          </a>
                      </li>
                      {% else %}
                      <li class="page-item disabled">
                          <span class="page-link">&laquo;&laquo;</span>
                      </li>
                      {% endif %}
        
                      {% if page_obj.has_previous %}
                      <li class="page-item">
                          <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Назад">
                              <span aria-hidden="true">&laquo;</span>
                          </a>
                      </li>
                      {% else %}
                      <li class="page-item disabled">
                          <span class="page-link">&laquo;</span>
                      </li>
                      {% endif %}
        
                      {% for page_num in visible_pages %}
                      {% if page_num  ==  page_obj.number %}
                      <li class="page-item active" aria-current="page">
                          <span class="page-link">{{ page_num }}</span>
                      </li>
                      {% else %}
                      <li class="page-item">
                          <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                      </li>
                      {% endif %}
                      {% endfor %}
        
                      {% if page_obj.has_next %}
                      <li class="page-item">
                          <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Вперёд">
                              <span aria-hidden="true">&raquo;</span>
                          </a>
                      </li>
                      {% else %}
                      <li class="page-item disabled">
                          <span class="page-link">&raquo;</span>
                      </li>
                      {% endif %}
        
                      {% if page_obj.number < page_obj.paginator.num_pages %}
                      <li class="page-item">
                          <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Последняя">
                              <span aria-hidden="true">&raquo;&raquo;</span>
                          </a>
                      </li>
                      {% else %}
                      <li class="page-item disabled">
                          <span class="page-link">&raquo;&raquo;</span>
                      </li>
                      {% endif %}
                  </ul>
              </nav>
              <div class="text-center mt-2">
                <small class="text-muted">Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</small>
            </div>
        
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .table {
    font-size: 14px; /* Уменьшаем размер текста */
    line-height: 1.2; /* Уменьшаем высоту строк */
  }
  .table th, .table td {
    padding: 0.5rem; /* Уменьшаем внутренние отступы (Bootstrap по умолчанию использует 0.75rem) */
    vertical-align: middle;
  }
  .checkbox-col {
    width: 1%;
    white-space: nowrap;
    padding-left: 0 !important;
  }
  .dropdown-menu {
    min-width: 200px;
  }
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  .checkbox-slide {
    transition: transform 0.3s ease, opacity 0.3s ease;
    transform: translateX(-20px);
    opacity: 0;
  }
  .checkbox-slide.visible {
    transform: translateX(0);
    opacity: 1;
  }
</style>

<script src="{% static 'assets/vendor/libs/jquery/jquery.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const $toggleBtnHeader = $("#toggle-checkboxes-header");
  const $toggleButton = $("#toggle-button");
  const $checkboxes = $(".order-checkbox");
  const $selectAllHeader = $("#select-all-header");
  const $selectAllOuter = $("#select-all");
  const $selectAllLabel = $("#select-all-pages");
  const $selectedCount = $("#selected-count");
  const $cancelSelection = $("#cancel-selection");
  const $exportButton = $("#exportButton");
  const $deleteButton = $("#deleteButton");

  const STORAGE_KEY = "selectedOrders";
  const CHECKBOX_VISIBILITY_KEY = "checkboxesVisibleOrders";

  // Обновление UI
  function updateUI() {
    const selectedOrders = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    $selectedCount.text(`Выбрано: ${selectedOrders.length}`);
    
    const pageChecked = $checkboxes.filter(":checked").length;
    const allPageChecked = pageChecked === $checkboxes.length && $checkboxes.length > 0;
    $selectAllHeader.prop("checked", allPageChecked);
  }

  // Сохранение выбранных заказов
  function saveSelectedOrders() {
    let selectedOrders = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    $checkboxes.each(function() {
      const orderId = $(this).data("order-id");
      const isChecked = $(this).prop("checked");
      if (isChecked && !selectedOrders.includes(orderId)) {
        selectedOrders.push(orderId);
      } else if (!isChecked && selectedOrders.includes(orderId)) {
        selectedOrders = selectedOrders.filter(id => id !== orderId);
      }
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(selectedOrders));
    updateUI();
  }

  // Восстановление состояния
  function restoreSelectedOrders() {
    const selectedOrders = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    $checkboxes.each(function() {
      const orderId = $(this).data("order-id");
      $(this).prop("checked", selectedOrders.includes(orderId));
    });
    updateUI();
  }

  // Очистка выбора
  function clearSelection() {
    localStorage.removeItem(STORAGE_KEY);
    $checkboxes.prop("checked", false);
    $selectAllHeader.prop("checked", false);
    $selectAllOuter.prop("checked", false);
    updateUI();
  }

  // Переключение видимости чекбоксов
  function toggleCheckboxes(show) {
    const shouldShow = typeof show === "boolean" ? show : !$checkboxes.hasClass("visible");
    
    if (shouldShow) {
      $checkboxes.removeClass("d-none").addClass("visible");
      $selectAllHeader.removeClass("d-none").addClass("visible");
      $selectAllOuter.removeClass("d-none");
      $selectAllLabel.removeClass("d-none");
      $selectedCount.removeClass("d-none");
      $cancelSelection.removeClass("d-none");
      $toggleButton.text("Скрыть выбор");
      localStorage.setItem(CHECKBOX_VISIBILITY_KEY, "true");
    } else {
      $checkboxes.removeClass("visible");
      setTimeout(() => $checkboxes.addClass("d-none"), 300);
      $selectAllHeader.removeClass("visible");
      setTimeout(() => $selectAllHeader.addClass("d-none"), 300);
      $selectAllOuter.addClass("d-none");
      $selectAllLabel.addClass("d-none");
      $selectedCount.addClass("d-none");
      $cancelSelection.addClass("d-none");
      $toggleButton.text("Выбрать");
      localStorage.removeItem(CHECKBOX_VISIBILITY_KEY);
    }
  }

  // Инициализация
  if (localStorage.getItem(CHECKBOX_VISIBILITY_KEY) === "true") {
    toggleCheckboxes(true);
  }
  restoreSelectedOrders();

  // Обработчики событий
  $toggleBtnHeader.on("click", function() {
    clearSelection();
    toggleCheckboxes();
  });

  $selectAllHeader.on("change", function() {
    const isChecked = $(this).prop("checked");
    $checkboxes.prop("checked", isChecked);
    saveSelectedOrders();
  });

  $selectAllOuter.on("change", function() {
    const shouldSelect = $(this).prop("checked");
    if (shouldSelect) {
      $.ajax({
        url: "{% url 'select-all-orders' %}",
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json"
        },
        data: JSON.stringify({ filters: window.location.search }),
        success: function(response) {
          if (response.success) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(response.selected_ids));
            restoreSelectedOrders();
          } else {
            $selectAllOuter.prop("checked", false);
            alert("Ошибка при выборе всех заказов");
          }
        },
        error: function() {
          $selectAllOuter.prop("checked", false);
          alert("Ошибка запроса");
        }
      });
    } else {
      clearSelection();
    }
  });

  $checkboxes.on("change", function() {
    saveSelectedOrders();
  });

  $cancelSelection.on("click", function() {
    clearSelection();
  });

  $selectAllLabel.on("click", function(e) {
    e.preventDefault();
    $selectAllOuter.prop("checked", true).trigger("change");
  });

  // Экспорт
  $exportButton.on("click", function() {
    const selectedOrders = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    if (selectedOrders.length > 0) {
      $("#exportModal").modal("show");
    } else {
      toggleCheckboxes(true);
    }
  });

  $("#exportSubmit").on("click", function() {
    const selectedOrders = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    if (selectedOrders.length === 0) {
      alert("Нет выбранных заказов для экспорта!");
      $("#exportModal").modal("hide");
      return;
    }

    const format = $("input[name='exportFormat']:checked").val();

    $.ajax({
      url: "{% url 'export-orders' %}",
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
      },
      data: JSON.stringify({
        order_ids: selectedOrders,
        format: format
      }),
      xhrFields: {
        responseType: 'blob'
      },
      success: function(response, status, xhr) {
        const filename = xhr.getResponseHeader('Content-Disposition')?.match(/filename="(.+)"/)?.[1] || `exported_orders.${format}`;
        const url = window.URL.createObjectURL(new Blob([response]));
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        $("#exportModal").modal("hide");
      },
      error: function(xhr) {
        let errorMsg = "Ошибка при экспорте заказов";
        if (xhr.responseJSON && xhr.responseJSON.error) {
          errorMsg += ": " + xhr.responseJSON.error;
        }
        alert(errorMsg);
      }
    });
  });

  // Удаление
  $deleteButton.on("click", function() {
    const selectedOrders = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    if (selectedOrders.length > 0) {
      $("#deleteCount").text(selectedOrders.length);
      $("#deleteModal").modal("show");
    } else {
      toggleCheckboxes(true);
    }
  });

  $("#deleteSubmit").on("click", function() {
    const selectedOrders = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    if (selectedOrders.length === 0) {
      alert("Нет выбранных заказов для удаления!");
      $("#deleteModal").modal("hide");
      return;
    }

    $.ajax({
      url: "{% url 'delete-orders' %}",
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
      },
      data: JSON.stringify({ order_ids: selectedOrders }),
      success: function(response) {
        if (response.success) {
          localStorage.removeItem(STORAGE_KEY);
          $("#deleteModal").modal("hide");
          location.reload();
        } else {
          alert("Ошибка при удалении: " + response.error);
        }
      },
      error: function() {
        alert("Ошибка запроса к серверу");
      }
    });
  });

  // Существующий код для печати чека
  const openReceiptButtons = document.querySelectorAll('.printReceipt');
  openReceiptButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const orderId = this.id.replace('openreceipt', '');
      const popupUrl = `/history/receipt/${orderId}`;
      const left = (window.screen.width - 200) / 2;
      const top = (window.screen.height - 600) / 4;

      const popupWindow = window.open(popupUrl, 'popupWindow', 
        `width=200,height=600,left=${left},top=${top},toolbar=no,menubar=no,scrollbars=no,resizable=no,location=no,status=no`
      );

      popupWindow.onload = function() {
        popupWindow.print();
        popupWindow.onafterprint = function() {
          popupWindow.close();
        };
      };
    });
  });
});
</script>

{% endblock %}